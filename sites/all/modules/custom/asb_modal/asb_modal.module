<?php

/**
 * Implements hook_form_alter()
 */
function asb_modal_form_alter(&$form, &$form_state, $form_id) {
  if($form_id == 'update_node_form' && $form['#action'] == '/asb-modal-callback/ajax') {
    dsm($form_state);
  }
}

/**
 * Implements hook_menu()
 */
function asb_modal_menu() {
  // Create an ajax path for the modal
  $items['asb-modal-callback/%ctools_js'] = array(
    'page callback' => 'asb_modal_modal_callback',
    'page arguments' => array(1),
    'access arguments' => array('create update content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function asb_modal_block_info() {
  $blocks['modal_update'] = array(
    'info' => t('Modal Update Block'),
  );
  return $blocks;
}

function asb_modal_block_view($block_name) {
  if ($block_name == 'modal_update') {
   
    ctools_include('modal');
    ctools_include('ajax');
    ctools_modal_add_js();
   
    return array(
      'subject' => t('Modal Update Title!'),
      'content' => ctools_modal_text_button(t('Click Here!'),'asb-modal-callback/nojs',t('Click Here!')),
    );
  }
}

function asb_modal_modal_callback($js = false) {
  // If the user doesn't have javascript, redirect them to the normal node/add/article page
  if (!$js) {
    drupal_goto('node/add/update');
  }
  else {
    // Javascript is on, prepare ctools modals.
    ctools_include('ajax');
    ctools_include('modal');

    // Pull in the global user, and prepare a blank node to pass to the node
    // add form.
    global $user;
    $node = (object) array('uid' => $user->uid, 'name' => (isset($user->name) ? $user->name : ''), 'type' => 'update', 'language' => LANGUAGE_NONE);
    $node->title = NULL;
    node_object_prepare($node);

    // Add the node.pages.inc so that functions from the form can be used.
    module_load_include('inc', 'node', 'node.pages');

    // Prepare the form state, ctools reqruies ajax / title.  The node add form
    // requires node.
    $form_state = array(
      'ajax' => true,
      'title' => t('Add Update'),
      'node' => $node,
    );

    // Do the ctools_modal_form_wrapping of the node form.  Returns a set of
    // ajax commands in output.
    $output = ctools_modal_form_wrapper('update_node_form', $form_state);

    if (!empty($form_state['executed'])) {

      // Add the responder javascript, required by ctools
      ctools_add_js('ajax-responder');

      // Create ajax command array, dismiss the modal window.
      $output = array();
      $output[] = ctools_modal_command_dismiss();
    }

    print ajax_render($output);
    exit;
  }
} 

